import React, { useCallback, useEffect, useState } from 'react';
import axios from 'axios';

const PersonalWorkWidget = ({ refreshTrigger }) => {
    const [allWork, setAllWork] = useState([]);      
    const [weekRange, setWeekRange] = useState('');         
    const [selectedDate, setSelectedDate] = useState('');   
    const [calendarDays, setCalendarDays] = useState([]);   
    const [loading, setLoading] = useState(true);

    // ì—…ë¬´ ìƒíƒœ ì½”ë“œ ë³€í™˜
    const getStatusLabel = (status) => {
        switch (parseInt(status)) {
            case 201: return { text: 'ìš”ì²­', color: 'bg-secondary' };
            case 202: return { text: 'ì§„í–‰', color: 'bg-primary' };
            case 203: return { text: 'ì™„ë£Œ', color: 'bg-success' };
            case 204: return { text: 'ë³´ë¥˜', color: 'bg-dark' };
            case 205: return { text: 'ì§€ì—°', color: 'bg-danger' };
            default: return { text: 'ë¯¸ì •', color: 'bg-secondary' };
        }
    };

    // ì˜¤ëŠ˜ ë‚ ì§œ
    const getTodayStr = () => {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        return new Date(now - offset).toISOString().split('T')[0];
    };

    // ì£¼ê°„ ìº˜ë¦°ë” ìƒì„± (ì¼~í† )
    const generateCalendar = useCallback((workList) => {
        const now = new Date(); // ê¸°ì¤€ì€ í•­ìƒ ì˜¤ëŠ˜ì´ ì†í•œ ì£¼
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay()); // ì¼ìš”ì¼ë¡œ ì´ë™

        const days = [];
        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        for (let i = 0; i < 7; i++) {
            const temp = new Date(startOfWeek);
            temp.setDate(startOfWeek.getDate() + i);

            // YYYY-MM-DD
            const yyyy = temp.getFullYear();
            const mm = String(temp.getMonth() + 1).padStart(2, '0');
            const dd = String(temp.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;

            // í•´ë‹¹ ë‚ ì§œì˜ ì—…ë¬´ ê°œìˆ˜
            const found = workList.find(w => w.WORK_DATE_STR === dateStr);
            const count = found ? found.DAILY_COUNT : 0;

            days.push({
                dateStr: dateStr,
                dayNum: dd,
                dayName: dayNames[i],
                count: count
            });
        }
        setCalendarDays(days);
    }, []);

    const fetchData = async (isInit = false) => {
        try {
            // setLoading(true); // ê¹œë¹¡ì„ ë°©ì§€ (ì„ íƒ)
            const res = await axios.get('/tudio/dashboard/personalWork');
            const { list, titleRange } = res.data;

            setAllWork(list || []);
            setWeekRange(titleRange);
            
            // ìº˜ë¦°ë” ê°±ì‹  (ìƒˆë¡œìš´ ì¹´ìš´íŠ¸ ë°˜ì˜)
            generateCalendar(list || []);

            // [ì´ˆê¸° ë¡œë“œì¼ ë•Œë§Œ] ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ
            if (isInit) {
                setSelectedDate(getTodayStr());
            }

        } catch (e) {
            console.error("ê°œì¸ì—…ë¬´ ë¡œë“œ ì‹¤íŒ¨", e);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData(true); // true: ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„ íƒ
    }, []);

    // ì†Œì¼“ ì‹ í˜¸ ìˆ˜ì‹  ì‹œ ì¬ì¡°íšŒ
    useEffect(() => {
        if (refreshTrigger > 0) {
            console.log("â™»ï¸ [ê°œì¸ì—…ë¬´] ê°±ì‹  ì‹ í˜¸ ìˆ˜ì‹  -> ì¬ì¡°íšŒ");
            fetchData(false); // false: í˜„ì¬ ì„ íƒëœ ë‚ ì§œ ìœ ì§€
        }
    }, [refreshTrigger]);

    // ì„ íƒëœ ë‚ ì§œì˜ ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ í•„í„°ë§
    const filteredList = allWork.filter(w => w.WORK_DATE_STR === selectedDate);

    // ì—…ë¬´ í´ë¦­ ì‹œ ì´ë™
    const handleMoveToTask = (work) => {
        window.location.href = `/tudio/project/detail?projectNo=${work.PROJECT_NO}&taskId=${work.WORK_ID}`;
    };

    const handleMoveToProject = (e, projectNo) => {
        e.stopPropagation(); 
        window.location.href = `/tudio/project/detail?projectNo=${projectNo}`;
    };

    if (loading) return <div className="text-center py-4"><span className="spinner-border spinner-border-sm text-primary"></span></div>;

    return (
        <div className="widget-content d-flex flex-column h-100 overflow-hidden">
            <div className="flex-shrink-0 p-3 pb-0">
                {/* í—¤ë” (íƒ€ì´í‹€ + ë‚ ì§œë²”ìœ„) */}
                <div className="d-flex justify-content-between align-items-center mb-3">
                    <h6 className="fw-bold m-0 text-dark">
                        <i className="bi bi-calendar-check text-primary me-2"></i>ê°œì¸ ì—…ë¬´
                    </h6>
                    <span className="badge bg-light text-secondary border">{weekRange}</span>
                </div>

                {/* ì£¼ê°„ ìº˜ë¦°ë” */}
                <div className="d-flex justify-content-between text-center bg-light rounded p-2 mt-3 mb-3">
                    {calendarDays.map((day, idx) => {
                        const isSelected = selectedDate === day.dateStr;
                        // ì¼ìš”ì¼(0): ë¹¨ê°•, í† ìš”ì¼(6): íŒŒë‘, í‰ì¼: ê²€ì •
                        const colorClass = idx === 0 ? 'text-danger' : idx === 6 ? 'text-primary' : 'text-dark';

                        return (
                            <div key={day.dateStr} 
                                onClick={() => setSelectedDate(day.dateStr)}
                                className={`calendar-day-box flex-fill p-1 rounded cursor-pointer position-relative ${isSelected ? 'bg-white shadow-sm border border-primary' : ''}`}
                            >
                                <div className={`small ${idx===0||idx===6 ? colorClass : 'text-muted'}`} style={{fontSize:'0.7rem'}}>
                                    {day.dayName}
                                </div>
                                <div className={`fw-bold mt-1 ${colorClass}`}>
                                    {day.dayNum}
                                    {day.count > 0 && (
                                        <span className="ms-1 text-primary small" style={{fontSize: '0.75rem', verticalAlign: 'top'}}>
                                            [{day.count}]
                                        </span>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>            

            {/* ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ */}
            <div className="flex-grow-1 overflow-auto custom-scrollbar px-3">
                <div className='d-flex align-items-center'>
                    <h6 className="small text-muted border-bottom pb-2 mt-3 mb-2">
                        ğŸ“… {selectedDate} ({filteredList.length}ê±´)
                    </h6>
                    <div className="info-icon-wrapper">
                        <i className="bi bi-info-circle text-secondary"></i>
                        <div className="info-tooltip">
                            <div className="d-flex align-items-center mb-1 fw-bold">
                                <i className="bi bi-bookmark-fill text-primary me-2"></i> ì—…ë¬´
                            </div>
                            <div className="d-flex align-items-center mb-1 fw-bold">
                                <i className="bi bi-arrow-return-right text-muted me-2"></i> ë‹¨ìœ„ ì—…ë¬´
                            </div>
                        </div>
                    </div>
                </div>

                {filteredList.length === 0 ? (
                    <div className="text-center text-muted py-4 small">
                        ì˜ˆì •ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                ) : (
                    <ul className="list-group list-group-flush px-0 py-0">
                        {filteredList.map((work, i) => {
                            const statusInfo = getStatusLabel(work.WORK_STATUS);
                            return (
                            <li key={i} 
                                className="list-group-item px-2 py-2 border-0 d-flex align-items-center list-group-item-action"
                                onClick={() => handleMoveToTask(work)} style={{cursor:'pointer'}}>
                                
                                <span className="badge bg-light text-dark border me-2 text-truncate" 
                                    style={{maxWidth: '180px', cursor: 'pointer'}}
                                    onClick={(e) => handleMoveToProject(e, work.PROJECT_NO)}
                                    title="í”„ë¡œì íŠ¸ë¡œ ì´ë™">
                                    {work.PROJECT_NAME}
                                </span>

                                {/* ì—…ë¬´ ì œëª© */}
                                <div className="text-truncate flex-grow-1 small fw-bold text-dark" title={work.WORK_TITLE}>
                                    {/* ì—…ë¬´/ë‹¨ìœ„ì—…ë¬´ ì•„ì´ì½˜ êµ¬ë¶„ */}
                                    {work.WORK_TYPE === 'TASK' ? 
                                        <i className="bi bi-bookmark-fill text-primary me-1" style={{fontSize: '0.7rem'}}></i> : 
                                        <i className="bi bi-arrow-return-right text-muted me-1" style={{fontSize: '0.7rem'}}></i>
                                    }
                                    {work.WORK_TITLE}
                                </div>
                                    
                                {/* ìƒíƒœ ì½”ë“œ í…ìŠ¤íŠ¸ ë³€í™˜ ì¶œë ¥ */}
                                <span className={`badge ${statusInfo.color} ms-2`} style={{minWidth: '50px'}}>
                                    {statusInfo.text}
                                </span>
                            </li>
                            );
                        })}
                    </ul>
                )}
            </div>

            <div className="flex-shrink-0 py-2 px-3 border-top text-end">
                 <span className="text-muted small" style={{fontSize: '0.75rem'}}>
                    <i className="bi bi-check2-circle me-1"></i>
                    ì˜¤ëŠ˜ ì™„ë£Œ: <span className="fw-bold">{allWork.filter(w=>w.WORK_DATE_STR === getTodayStr() && w.WORK_STATUS == 203).length}ê±´</span>
                </span>
            </div>
        </div>
    );
};

export default PersonalWorkWidget;