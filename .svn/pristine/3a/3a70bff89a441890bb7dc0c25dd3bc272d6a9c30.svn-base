import React, { useEffect, useState, useCallback, useMemo } from 'react';
import axios from 'axios';
import {
  Ban,
  Building2,
  CheckCircle2,
  ChevronRight,
  Download,
  FileUp,
  Search,
  Trash2,
  User,
  UserPlus,
  Users,
  Activity,
  ArrowUpDown,
  ArrowUp,
  ArrowDown
} from 'lucide-react';
import Swal from 'sweetalert2'; 

// [임포트] 사용자님의 공통 페이징 컴포넌트
import Pagination from '../../../components/common/Pagination';

// CSS 임포트
import '../../../assets/css/admin/pages/AdminCommon.css';

const UserList = () => {
  // --- [1. State 관리] ---
  const [activeTab, setActiveTab] = useState('all');
  const [users, setUsers] = useState([]); 
  const [loading, setLoading] = useState(true); 
  const [selectedUser, setSelectedUser] = useState(null);
  const [showCompanyModal, setShowCompanyModal] = useState(false);
  const [showGeneralModal, setShowGeneralModal] = useState(false);
  
  const [searchKeyword, setSearchKeyword] = useState(''); 
  const [finalKeyword, setFinalKeyword] = useState('');   

  // 페이징 관련 상태
  const [currentPage, setCurrentPage] = useState(1);
  const [pageInfo, setPageInfo] = useState(null);

  // 정렬 상태 (초기값: 가입일 내림차순)
  const [sortConfig, setSortConfig] = useState({ key: 'memberJoinDate', direction: 'desc' });

  // 상단 카드 전용 상태 (탈퇴 회원 항목 포함)
  const [summaryStats, setSummaryStats] = useState({
    total: 0,
    todayNew: 0,
    active: 0,
    withdrawn: 0 
  });

  // --- [2. API 호출 및 데이터 처리 로직] ---

  // 상단 요약 통계 전용 API 호출
  const fetchMemberStats = async () => {
    try {
      const response = await axios.get('/api/member/stats');
      const data = response.data;
      
      // MyBatis가 반환하는 Map의 Key 대응
      setSummaryStats({
        total: data.totalCount || data.TOTALCOUNT || 0,
        todayNew: data.todayCount || data.TODAYCOUNT || 0,
        active: data.activeCount || data.ACTIVECOUNT || 0,
        withdrawn: data.withdrawnCount || data.WITHDRAWNCOUNT || 0 
      });
    } catch (error) {
      console.error("통계 데이터 로드 실패:", error);
    }
  };

  // 회원 목록 호출
  const fetchUsers = useCallback(async () => {
    setLoading(true);
    try {
      const response = await axios.get(`/api/member/list`, {
        params: {
          type: activeTab,
          page: currentPage,
          keyword: finalKeyword
        }
      });
      
      if (response.data && response.data.dataList) {
        // [안전장치] 데이터가 없는데 현재 페이지가 1보다 크면 1페이지로 리셋
        if (response.data.dataList.length === 0 && currentPage > 1) {
          setCurrentPage(1);
          return;
        }
        setUsers(response.data.dataList);
        setPageInfo(response.data.pageInfo);
      } else {
        setUsers([]);
        setPageInfo(null);
      }
    } catch (error) {
      console.error("회원 목록 로드 실패:", error);
      setUsers([]);
      setPageInfo(null);
    } finally {
      setLoading(false);
    }
  }, [activeTab, currentPage, finalKeyword]);

  // 초기 렌더링 시 통계 호출
  useEffect(() => {
    fetchMemberStats(); 
  }, []);

  // 탭/검색어 변경 시 페이지 리셋
  useEffect(() => {
    setCurrentPage(1);
  }, [activeTab, finalKeyword]);

  // 데이터 로드 실행
  useEffect(() => {
    fetchUsers();
  }, [fetchUsers]);

  // 정렬 요청 함수
  const requestSort = (key) => {
    let direction = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });
  };

  // 클라이언트 사이드 정렬 로직
  const processedUsers = useMemo(() => {
    if (!Array.isArray(users)) return [];

    let result = [...users];
    result.sort((a, b) => {
      let valA = a[sortConfig.key] || '';
      let valB = b[sortConfig.key] || '';

      // 가입일 정렬 처리 (Date 객체 변환)
      if (sortConfig.key === 'memberJoinDate') {
        return sortConfig.direction === 'asc' 
          ? new Date(valA) - new Date(valB) 
          : new Date(valB) - new Date(valA);
      }

      // 일반 문자열 정렬
      if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
      if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
    return result;
  }, [users, sortConfig]);

  // 정렬 아이콘 렌더링 도우미
  const getSortIcon = (key) => {
    if (sortConfig.key !== key) return <ArrowUpDown size={14} className="ms-1 opacity-50" />;
    return sortConfig.direction === 'asc' 
      ? <ArrowUp size={14} className="ms-1" /> 
      : <ArrowDown size={14} className="ms-1" />;
  };

  const handleSearch = () => {
    setFinalKeyword(searchKeyword);
    setCurrentPage(1);
  };

  const handlePageChange = (pageNum) => {
    setCurrentPage(pageNum);
  };

  // --- [3. 이벤트 핸들러] ---

  const handleDownloadExcel = () => {
    const url = `/api/member/download-excel?type=${activeTab}&keyword=${finalKeyword}`;
    window.location.href = url;
  };

  const handleNewMemberClick = async () => {
    const { value: file } = await Swal.fire({
      title: '회원 일괄 등록',
      text: '회원 정보가 담긴 엑셀 파일(.xlsx, .xls)을 선택해주세요.',
      input: 'file',
      inputAttributes: { 'accept': '.xlsx, .xls' },
      showCancelButton: true,
      confirmButtonText: '업로드 시작',
      cancelButtonText: '취소'
    });

    if (file) {
      const formData = new FormData();
      formData.append('excelFile', file); 
      Swal.fire({ title: '업로드 중...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      try {
        const response = await axios.post('/api/member/upload-excel', formData);
        if (response.status === 200) {
          Swal.fire({ icon: 'success', title: '등록 완료', text: `${response.data.count || 0}명의 회원이 등록되었습니다.` });
          fetchUsers(); 
          fetchMemberStats(); 
        }
      } catch (error) {
        Swal.fire({ icon: 'error', title: '업로드 실패', text: error.response?.data || '데이터 형식을 확인해주세요.' });
      }
    }
  };

  const openModal = async (user) => {
    setSelectedUser({ ...user }); 
    try {
      const response = await axios.get(`/api/member/detail?memberNo=${user.memberNo}`);
      if (response.data) setSelectedUser({ ...response.data }); 
    } catch (error) {
      console.warn("상세 API 호출 실패");
    } finally {
      const isClient = user.memberAuthVOList?.some(a => a.auth === 'ROLE_CLIENT');
      if (isClient) setShowCompanyModal(true);
      else setShowGeneralModal(true);
    }
  };

  const closeModal = () => {
    setShowCompanyModal(false);
    setShowGeneralModal(false);
    setSelectedUser(null);
  };

  const handleDelete = async () => {
    const result = await Swal.fire({
      title: '정말로 삭제하시겠습니까?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: '삭제'
    });

    if (result.isConfirmed) {
      try {
        await axios.delete(`/api/member/delete/${selectedUser.memberNo}`);
        Swal.fire('완료', '삭제되었습니다.', 'success');
        fetchUsers(); 
        fetchMemberStats(); 
        closeModal();
      } catch (error) {
        Swal.fire('오류', '삭제 중 오류 발생', 'error');
      }
    }
  };

  // --- [4. 렌더링 영역] ---
  return (
    <div className="flex-grow-1 p-5 d-flex flex-column admin-content-wrapper meeting-room-scope">
      
      {/* 타이틀 영역 */}
      <div className="admin-title-row mb-4 d-flex justify-content-between align-items-end">
        <div>
          <nav className="text-muted small mb-2 d-flex align-items-center gap-2">
            <span>Admin</span> <ChevronRight size={12} /> <span className="text-primary fw-bold">회원 관리</span>
          </nav>
          <h2 className="admin-page-title m-0"><i className="bi bi-people-fill me-2"></i>회원 조회</h2>
        </div>
        <div className="d-flex gap-2">
          <button className="btn btn-outline-secondary d-flex align-items-center gap-2 fw-bold px-3 shadow-sm" onClick={handleDownloadExcel}>
            <Download size={18} /> 일괄 다운로드 (Excel)
          </button>
          <button className="btn btn-primary d-flex align-items-center gap-2 fw-bold px-4 shadow-sm" onClick={handleNewMemberClick}>
            <FileUp size={18} /> 신규 회원 등록 (Excel)
          </button>
        </div>
      </div>

      {/* 통계 카드 */}
      <div className="row g-4 mb-5">
          <div className="col-3">
            <div className="admin-stat-card h-100">
                <div className="stat-header"><Users size={18} className="text-primary-custom me-2" /> 누적 회원</div>
                <div className="stat-value-row">
                    <span className="stat-value-big text-primary-custom">{summaryStats.total.toLocaleString()}</span>
                    <span className="text-muted small">명</span>
                </div>
            </div>
          </div>
          <div className="col-3">
            <div className="admin-stat-card h-100">
                <div className="stat-header"><UserPlus size={18} className="text-success me-2" /> 오늘 가입</div>
                <div className="stat-value-row">
                    <span className="stat-value-big text-success">{summaryStats.todayNew.toLocaleString()}</span>
                    <span className="text-muted small">명</span>
                </div>
            </div>
          </div>
          <div className="col-3">
            <div className="admin-stat-card h-100">
                <div className="stat-header"><Activity size={18} className="text-warning me-2" /> 활성 유저</div>
                <div className="stat-value-row">
                    <span className="stat-value-big text-warning">{summaryStats.active.toLocaleString()}</span>
                    <span className="text-muted small">명</span>
                </div>
            </div>
          </div>
          <div className="col-3">
            <div className="admin-stat-card h-100">
                <div className="stat-header">
                  <Ban size={18} style={{ color: '#ff6b6b' }} className="me-2" /> 탈퇴 회원
                </div>
                <div className="stat-value-row">
                    <span className="stat-value-big" style={{ color: '#ff6b6b' }}>
                      {summaryStats.withdrawn.toLocaleString()}
                    </span>
                    <span className="text-muted small">명</span>
                </div>
            </div>
          </div>
      </div>

      {/* 필터 탭 */}
      <div className="filter-tabs mb-4">
        {['all', 'general', 'company', 'withdrawal'].map(tab => (
          <button 
            key={tab}
            className={`filter-btn ${activeTab === tab ? 'active' : ''}`}
            onClick={() => setActiveTab(tab)}
          >
            {tab === 'all' ? '전체' : tab === 'general' ? '일반' : tab === 'company' ? '기업' : '탈퇴'}
          </button>
        ))}
      </div>

      {/* 상세 목록 테이블 */}
      <div className="admin-common-box shadow-sm border-0 flex-grow-1 d-flex flex-column overflow-hidden mb-4">
        <div className="p-4 bg-white border-bottom d-flex justify-content-between align-items-center">
          <h4 className="m-0 fw-bold" style={{fontSize: '1.15rem'}}>
            상세 목록 <span className="text-primary ms-2 small">{pageInfo?.totalRecord || 0}건</span>
          </h4>
          
          {/* 검색창 및 정렬 버튼 그룹 (오른쪽 정렬) */}
          <div className="d-flex align-items-center gap-3">
            {/* 정렬 버튼 그룹 */}
            <div className="d-flex gap-2">
              <button 
                className={`btn btn-sm px-3 rounded-pill d-flex align-items-center fw-bold transition-all ${sortConfig.key === 'memberName' ? 'btn-primary' : 'btn-outline-secondary border-light-subtle text-muted'}`}
                onClick={() => requestSort('memberName')}
              >
                이름순 {getSortIcon('memberName')}
              </button>
              <button 
                className={`btn btn-sm px-3 rounded-pill d-flex align-items-center fw-bold transition-all ${sortConfig.key === 'companyName' ? 'btn-primary' : 'btn-outline-secondary border-light-subtle text-muted'}`}
                onClick={() => requestSort('companyName')}
              >
                소속순 {getSortIcon('companyName')}
              </button>
              <button 
                className={`btn btn-sm px-3 rounded-pill d-flex align-items-center fw-bold transition-all ${sortConfig.key === 'memberJoinDate' ? 'btn-primary' : 'btn-outline-secondary border-light-subtle text-muted'}`}
                onClick={() => requestSort('memberJoinDate')}
              >
                가입일순 {getSortIcon('memberJoinDate')}
              </button>
            </div>

            {/* 검색 입력창 */}
            <div className="d-flex gap-2">
              <input 
                type="text" 
                className="form-control rounded-pill border-light bg-light ps-3" 
                placeholder="이름, ID 검색..." 
                value={searchKeyword}
                onChange={(e) => setSearchKeyword(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                style={{ width: '220px' }}
              />
              <button className="btn btn-primary px-4 rounded-pill fw-bold" onClick={handleSearch}>
                검색
              </button>
            </div>
          </div>
        </div>

        <div className="card-body p-0">
          <div className="table-responsive">
            <table className="res-table align-middle mb-0 w-100">
              <thead>
                <tr>
                  <th className="text-center" style={{ width: '8%' }}>유형</th>
                  <th className="text-center" style={{ width: '10%' }}>이름</th>
                  <th style={{ width: '30%' }}>소속(기업명)</th>
                  <th style={{ width: '12%' }}>계정(ID)</th>
                  <th className="text-center" style={{ width: '7%' }}>프로젝트</th>
                  <th className="text-center" style={{ width: '8%' }}>상태</th>
                  <th className="text-center" style={{ width: '13%' }}>가입일</th>
                  <th className="text-center pe-4" style={{ width: '12%' }}>상세</th>
                </tr>
              </thead>
              <tbody>
                {loading ? (
                  <tr><td colSpan="8" className="text-center py-5">로딩 중...</td></tr>
                ) : processedUsers.length > 0 ? (
                  processedUsers.map((user) => (
                    <tr key={user.memberNo}>
                      <td className="ps-4 text-center">
                        <span className={`badge rounded-pill border px-2 py-1 ${user.memberAuthVOList?.some(a => a.auth === 'ROLE_CLIENT') ? 'bg-info bg-opacity-10 text-info border-info' : 'bg-secondary bg-opacity-10 text-secondary border-secondary'}`}>
                          {user.memberAuthVOList?.some(a => a.auth === 'ROLE_CLIENT') ? '기업' : '일반'}
                        </span>
                      </td>
                      <td className="fw-bold text-center text-nowrap">{user.memberName}</td>
                      <td>{user.companyName || '-'}</td>
                      <td className="text-nowrap">{user.memberId}</td>
                      <td className="text-center text-nowrap">{user.projectCount || 0}건</td>
                      <td className='fw-bold text-center text-nowrap'>
                        {user.leaveStatus === 'Y' ? 
                          <span className="text-danger">탈퇴</span> : 
                          <span className="text-success">활성</span>
                        }
                      </td>
                      <td className="text-center text-nowrap">{user.memberJoinDate ? user.memberJoinDate.split(' ')[0] : '-'}</td>
                      <td className="text-center pe-4">
                        <button className="tudio-btn tudio-btn-outline-primary btn-sm px-3 text-nowrap" onClick={() => openModal(user)}>상세보기</button>
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr><td colSpan="8" className="text-center py-5">결과가 없습니다.</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {/* 페이징 컴포넌트 */}
      {processedUsers.length > 0 && pageInfo && (
        <div className="d-flex justify-content-center pb-4">
          <Pagination pageInfo={pageInfo} onPageChange={handlePageChange} />
        </div>
      )}

      {/* --- 모달 영역 --- */}
      {/* 1. 기업 회원 상세 모달 */}
      {showCompanyModal && selectedUser && (
        <div className="modal fade show d-block" style={{backgroundColor: 'rgba(0,0,0,0.5)'}}>
          <div className="modal-dialog modal-lg modal-dialog-centered">
            <div className="modal-content border-0 shadow-lg">
              <div className="modal-header bg-light">
                <h5 className="modal-title fw-bold">기업 회원 상세 정보</h5>
                <button type="button" className="btn-close" onClick={closeModal}></button>
              </div>
              <div className="modal-body p-4 text-dark">
                <p><strong>기업명:</strong> {selectedUser.companyName || selectedUser.memberName}</p>
                <p><strong>대표자:</strong> {selectedUser.memberName}</p>
                <p><strong>계정:</strong> {selectedUser.memberId}</p>
                <p><strong>연락처:</strong> {selectedUser.memberTel}</p>
              </div>
              <div className="modal-footer border-0">
                <button className="btn btn-outline-danger me-auto" onClick={handleDelete}>영구 삭제</button>
                <button className="btn btn-secondary" onClick={closeModal}>닫기</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* 2. 일반 회원 상세 모달 */}
      {showGeneralModal && selectedUser && (
        <div className="modal fade show d-block" style={{backgroundColor: 'rgba(0,0,0,0.5)'}}>
          <div className="modal-dialog modal-dialog-centered">
            <div className="modal-content border-0 shadow-lg">
              <div className="modal-header bg-light">
                <h5 className="modal-title fw-bold">일반 회원 상세 정보</h5>
                <button type="button" className="btn-close" onClick={closeModal}></button>
              </div>
              <div className="modal-body p-4 text-dark">
                <p><strong>이름:</strong> {selectedUser.memberName}</p>
                <p><strong>부서:</strong> {selectedUser.memberDepartment || '없음'}</p>
                <p><strong>이메일:</strong> {selectedUser.memberEmail}</p>
              </div>
              <div className="modal-footer border-0">
                <button className="btn btn-outline-danger me-auto" onClick={handleDelete}>영구 삭제</button>
                <button className="btn btn-secondary" onClick={closeModal}>닫기</button>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

export default UserList;