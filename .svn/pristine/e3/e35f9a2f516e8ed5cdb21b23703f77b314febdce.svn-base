import axios from 'axios';
import {
  Activity,
  AlertCircle, // ArrowRepeat ëŒ€ì‹  RotateCw ì‚¬ìš©
  CheckCircle2,
  ChevronRight,
  Clock,
  FileSpreadsheet,
  Info,
  RotateCw,
  Search,
  Zap
} from 'lucide-react';
import { useEffect, useState } from 'react';
import { useSearchParams } from 'react-router-dom';
import Pagination from '../../../components/common/Pagination';

const LogBatch = () => {
  const [querySearchParams, setQuerySearchParams] = useSearchParams();
  const currentPage = parseInt(querySearchParams.get('page')) || 1;
  const [logs, setLogs] = useState([]);
  const [pageInfo, setPageInfo] = useState(null);

  // í•„í„° ìƒíƒœ (ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€)
  const today = new Date().toISOString().split('T')[0];
  const [filters, setFilters] = useState({ 
    startDate: today, 
    endDate: today, 
    keyword: '', 
    status: 'all' 
  });

  const stats = {
    total: pageInfo?.totalRecord || 0,
    success: logs.filter(l => l.batchStatus === 'SUCCESS').length,
    fail: logs.filter(l => l.batchStatus === 'FAIL').length,
    // í‰ê·  ì†Œìš” ì‹œê°„ ê³„ì‚°
    avgDuration: logs.length > 0 
      ? Math.round(logs.reduce((acc, curr) => acc + (curr.duration || 0), 0) / logs.length) 
      : 0
  };

  useEffect(() => { fetchLogs(); }, [currentPage]);

  const fetchLogs = async () => {
    try {
      const params = { 
        page: currentPage, 
        searchWord: filters.keyword, 
        startDate: filters.startDate,
        endDate: filters.endDate,
        status: filters.status
      };
      const response = await axios.get('/api/log/batch/list', { params });
      
      // ì„œë²„ì—ì„œ PaginationInfoVO ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë¦¬í„´í•˜ë¯€ë¡œ êµ¬ì¡°ì— ë§ì¶° ì„¸íŒ…
      setLogs(response.data.dataList || []);
      setPageInfo(response.data); 
    } catch (error) {
      console.error("ë°°ì¹˜ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨:", error);
    }
  };

  // ì†Œìš” ì‹œê°„ í¬ë§·íŒ… (ì´ˆ -> ë¶„/ì´ˆ)
  const formatDuration = (seconds) => {
    if (!seconds || seconds < 0) return "0ì´ˆ";
    if (seconds < 60) return `${seconds}ì´ˆ`;
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}ë¶„ ${sec}ì´ˆ`;
  };

  return (
    <div className="flex-grow-1 p-5 d-flex flex-column h-100">
      {/* í—¤ë” ì˜ì—­ */}
      <div className="mb-4">
        <nav className="text-muted small mb-2 d-flex align-items-center gap-2">
          <span>Admin</span> <ChevronRight size={12} /> <span>ë¡œê·¸ ê´€ë¦¬</span> <ChevronRight size={12} /> <span className="text-primary fw-bold">ë°°ì¹˜ ë¡œê·¸</span>
        </nav>
        <h2 className="fw-bold text-dark m-0 d-flex align-items-center gap-2">
          <RotateCw size={24} className="text-primary" /> ë°°ì¹˜ ë¡œê·¸ ì¡°íšŒ
        </h2>
      </div>

      <div className="summary-container mb-4">
        {/* ì „ì²´ ì‹¤í–‰ ê±´ìˆ˜ */}
        <div className="summary-card">
          <span className="summary-label text-primary-custom">
            <Activity size={16} /> ì „ì²´ ì‹¤í–‰ íšŸìˆ˜
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value me-2">{stats.total.toLocaleString()}</div>
            <span className="text-muted small">ê±´</span>
          </div>
          <span className="small text-muted mt-1">ìŠ¤ì¼€ì¤„ëŸ¬ì— ì˜í•œ ì´ ì‹¤í–‰ìˆ˜</span>
        </div>

        {/* ì‹¤í–‰ ì„±ê³µ (Success) */}
        <div className="summary-card">
          <span className="summary-label text-success">
            <CheckCircle2 size={16} /> ì‹¤í–‰ ì„±ê³µ
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-success me-2">{stats.success}</div>
            <span className="text-muted small">ê±´</span>
          </div>
          <span className="small text-muted mt-1">ì •ìƒ ì¢…ë£Œëœ ë°°ì¹˜ ì‘ì—…</span>
        </div>

        {/* ì‹¤í–‰ ì‹¤íŒ¨ (Fail) */}
        <div className="summary-card">
          <span className="summary-label text-danger-custom">
            <AlertCircle size={16} /> ì‹¤í–‰ ì‹¤íŒ¨
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-danger-custom me-2">{stats.fail}</div>
            <span className="text-muted small">ê±´</span>
          </div>
          <span className="small text-danger-custom mt-1 fw-bold">ì—ëŸ¬ ë¡œê·¸ í™•ì¸ í•„ìš”</span>
        </div>

        {/* í‰ê·  ì†Œìš” ì‹œê°„ (Performance) */}
        <div className="summary-card">
          <span className="summary-label text-warning-custom">
            <Zap size={16} /> í‰ê·  ì†Œìš” ì‹œê°„
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-warning-custom me-2">
              {formatDuration(stats.avgDuration)}
            </div>
          </div>
          <span className="small text-muted mt-1">ì‘ì—…ë‹¹ í‰ê·  í¼í¬ë¨¼ìŠ¤</span>
        </div>
      </div>

      {/* ê²€ìƒ‰ í•„í„° */}
      <div className="card border-0 shadow-sm rounded-3 mb-4 bg-light p-4">
        <div className="row g-3 align-items-end">
          <div className="col-md-3">
            <label className="form-label fw-bold small text-muted">ì¡°íšŒ ê¸°ê°„</label>
            <div className="input-group">
              <input type="date" className="form-control" value={filters.startDate} onChange={(e) => setFilters({...filters, startDate: e.target.value})} />
              <input type="date" className="form-control" value={filters.endDate} onChange={(e) => setFilters({...filters, endDate: e.target.value})} />
            </div>
          </div>
          <div className="col-md-2">
            <label className="form-label fw-bold small text-muted">ìƒíƒœ</label>
            <select className="form-select" value={filters.status} onChange={(e) => setFilters({...filters, status: e.target.value})}>
              <option value="all">ì „ì²´</option>
              <option value="SUCCESS">ì„±ê³µ</option>
              <option value="FAIL">ì‹¤íŒ¨</option>
            </select>
          </div>
          <div className="col-md-5">
            <label className="form-label fw-bold small text-muted">ê²€ìƒ‰ì–´ (ì‘ì—…ëª…/ë©”ì‹œì§€)</label>
            <input type="text" className="form-control" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" value={filters.keyword} onChange={(e) => setFilters({...filters, keyword: e.target.value})} onKeyDown={(e) => e.key === 'Enter' && fetchLogs()} />
          </div>
          <div className="col-md-2">
            <button className="btn btn-primary w-100" onClick={fetchLogs}><Search size={18} /></button>
          </div>
        </div>
      </div>

      {/* ëª©ë¡ í…Œì´ë¸” */}
      <div className="card border-0 shadow-sm rounded-3 overflow-hidden d-flex flex-column bg-white">
        <div className="p-3 border-bottom d-flex justify-content-between align-items-center">
          <div><h5 className="fw-bold mb-1">ğŸ“‹ ë°°ì¹˜ ì‹¤í–‰ ëª©ë¡</h5><small className="text-muted">ì´ <span className="text-primary fw-bold">{pageInfo?.totalRecord || 0}</span>ê±´</small></div>
          <button className="btn btn-success btn-sm d-flex align-items-center gap-2 px-3"><FileSpreadsheet size={16}/> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div className="table-responsive">
          <table className="table table-hover align-middle mb-0">
            <thead className="bg-light text-muted small">
              <tr>
                <th className="text-center" style={{width:'60px'}}>No</th>
                <th>ì‘ì—…ëª…</th><th className="text-center">ìƒíƒœ</th><th>ì‹¤í–‰ ì •ë³´</th><th>ì†Œìš” ì‹œê°„</th><th>ì‹œì‘ / ì¢…ë£Œ ì¼ì‹œ</th>
              </tr>
            </thead>
            <tbody>
              {logs.map((log, index) => {
                const total = pageInfo?.totalRecord || 0;
                const current = pageInfo?.currentPage || 1;
                const size = pageInfo?.rowSize || 10;
                const rowNo = total - ((current - 1) * size) - index;

                return (
                  <tr key={log.batchLogId || index}>
                    <td className="text-center small text-muted">{rowNo || '-'}</td>
                    <td>
                      <div className="fw-bold text-dark">{log.jobName}</div>
                      <div className="text-muted" style={{fontSize:'0.75rem'}}><Info size={10}/> {log.batchParams || 'íŒŒë¼ë¯¸í„° ì—†ìŒ'}</div>
                    </td>
                    <td className="text-center">
                      {log.batchStatus === 'SUCCESS' ? (
                        <span className="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3"><CheckCircle2 size={12}/> ì„±ê³µ</span>
                      ) : (
                        <span className="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill px-3"><AlertCircle size={12}/> ì‹¤íŒ¨</span>
                      )}
                    </td>
                    <td className="small">
                      <div className="text-truncate" style={{maxWidth:'250px'}} title={log.resultMsg}>{log.resultMsg}</div>
                      {log.errorLogId && (
                        <button 
                          className="btn btn-link p-0 small text-danger" 
                          style={{fontSize:'0.75rem'}}
                          onClick={() => alert(`ì—ëŸ¬ ë¡œê·¸ #${log.errorLogId} ìƒì„¸ ë³´ê¸°ë¡œ ì´ë™í•©ë‹ˆë‹¤.`)}
                        >
                          ìƒì„¸ ì—ëŸ¬ ë³´ê¸° # {log.errorLogId}
                        </button>
                      )}
                    </td>
                    <td className="small text-muted"><Clock size={12}/> {formatDuration(log.duration)}</td>
                    <td className="small text-muted">
                      <div>S: {log.startDate ? new Date(log.startDate).toLocaleString() : '-'}</div>
                      <div>E: {log.regDate ? new Date(log.regDate).toLocaleString() : '-'}</div>
                    </td>
                  </tr>
                );
              })}
              {logs.length === 0 && <tr><td colSpan="6" className="text-center py-5 text-muted">ì¡°íšŒëœ ë°°ì¹˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>}
            </tbody>
          </table>
        </div>
        {pageInfo && pageInfo.totalRecord > 0 && (
          <div className="p-4 border-top">
            <Pagination 
              pageInfo={pageInfo} 
              onPageChange={(n) => setQuerySearchParams({page: n})} 
            />
          </div>
        )}
      </div>
    </div>
  );
};

export default LogBatch;