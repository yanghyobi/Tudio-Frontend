import axios from 'axios';
import {
  Activity,
  AlertCircle,
  AlertTriangle,
  CheckCircle2,
  ChevronRight,
  ClipboardCheck,
  Clock, Copy,
  FileSpreadsheet,
  Info,
  Link2,
  RotateCcw,
  Search,
  ShieldAlert
} from 'lucide-react';
import { useEffect, useState } from 'react';
import Swal from 'sweetalert2';
import Pagination from '../../../components/common/Pagination';

const LogError = () => {
  const [logs, setLogs] = useState([]);
  const [selectedLog, setSelectedLog] = useState(null);
  const [pageInfo, setPageInfo] = useState(null);
  const [copied, setCopied] = useState(false);

  const today = new Date().toISOString().split('T')[0];

  const [searchParams, setSearchParams] = useState({
    startDate: today,
    endDate: today,
    keyword: '',
    page: 1
  });

  const stats = {
    total: pageInfo?.totalRecord || 0,
    unresolved: logs.filter(l => l.errStatus !== 'RESOLVED').length,
    resolved: logs.filter(l => l.errStatus === 'RESOLVED').length,
    critical: logs.filter(l => l.statusCode === 500).length
  };

  const fetchLogs = async () => {
    try {
      const response = await axios.get('/api/log/error/list', {
        params: {
          page: searchParams.page,
          searchWord: searchParams.keyword,
          startDate: searchParams.startDate,
          endDate: searchParams.endDate
        }
      });
      const dataList = response.data.dataList || [];
      const pi = response.data.pageInfo || null;
      setLogs(dataList);
      setPageInfo(pi);
    } catch (error) {
      console.error("에러 로그 조회 실패:", error);
      setLogs([]);
      setPageInfo(null);
    }
  };

  useEffect(() => {
    fetchLogs();
  }, [searchParams.page]);

  const handleResolve = async (errorLogId) => {
    const result = await Swal.fire({
      title: '해결 완료 처리',
      text: "해당 오류를 '해결 완료' 상태로 변경하시겠습니까?",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: 'var(--main-blue)',
      cancelButtonColor: '#64748b',
      confirmButtonText: '처리',
      cancelButtonText: '취소'
    });

    if (result.isConfirmed) {
      try {
        await axios.put(`/api/log/error/resolve/${errorLogId}`);
        setLogs(prevLogs => 
          prevLogs.map(log => 
            log.errorLogId === errorLogId ? { ...log, errStatus: 'RESOLVED' } : log
          )
        );
        if (selectedLog && selectedLog.errorLogId === errorLogId) {
          setSelectedLog(prev => ({ ...prev, errStatus: 'RESOLVED' }));
        }
        Swal.fire('완료', '정상적으로 처리되었습니다.', 'success');
        fetchLogs();
      } catch (error) {
        Swal.fire('오류', '처리 중 문제가 발생했습니다.', 'error');
      }
    }
  };

  const handleSearch = () => {
    setSearchParams(prev => ({ ...prev, page: 1 }));
    fetchLogs();
  };

  const handleReset = () => {
    setSearchParams({ startDate: today, endDate: today, keyword: '', page: 1});
  };

  const handlePageChange = (page) => {
    setSearchParams(prev => ({ ...prev, page: page }));
  };

  const closeModal = () => {
    setSelectedLog(null);
    setCopied(false);
  };

  const handleCopy = (text) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const getCodeBadge = (statusCode) => {
    if (!statusCode) return <span className="badge bg-secondary">Error</span>;
    const colors = { 404: 'warning', 403: 'primary', 500: 'danger' };
    const color = colors[statusCode] || 'secondary';
    return (
      <span className={`badge bg-${color} bg-opacity-10 text-${color === 'warning' ? 'dark' : color} border border-${color} border-opacity-25 fw-bold`}>
        {statusCode}
      </span>
    );
  };

  const handleDownload = () => {
    const total = pageInfo?.totalRecord || 0;
    Swal.fire({
      title: '엑셀 다운로드',
      text: `조회된 ${total}건을 다운로드 하시겠습니까?`,
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: '다운로드'
    }).then((res) => {
      if(res.isConfirmed) Swal.fire('시작', '다운로드를 시작합니다.', 'success');
    });
  };

  /* [렌더링 디자인 개선] */
  return (
    <div className="flex-grow-1 p-5 d-flex flex-column h-100" style={{ backgroundColor: 'var(--bg-body)' }}>
      {/* 1. 헤더 영역 */}
      <div className="mb-4">
        <nav className="small mb-2 d-flex align-items-center gap-2" style={{ color: 'var(--text-muted)' }}>
          <span>Admin</span> <ChevronRight size={12} /> 
          <span>로그 관리</span> <ChevronRight size={12} />
          <span className="fw-bold" style={{ color: 'var(--main-blue)' }}>오류 로그</span>
        </nav>
        <h2 className="fw-bold m-0 d-flex align-items-center gap-2" style={{ color: 'var(--text-main)' }}>
          <AlertTriangle size={28} className="text-danger" /> 시스템 오류 발생 내역
        </h2>
      </div>

      <div className="summary-container">
        {/* 전체 감지 오류 */}
        <div className="summary-card">
          <span className="summary-label text-primary-custom">
            <Activity size={16} /> 전체 감지 오류
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value me-2">{stats.total.toLocaleString()}</div>
            <span className="text-muted small">건</span>
          </div>
          <span className="small text-muted mt-1">시스템에서 감지된 총 로그</span>
        </div>

        {/* 미해결 오류 (Danger) */}
        <div className="summary-card">
          <span className="summary-label text-danger-custom">
            <AlertTriangle size={16} /> 미해결 오류
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-danger-custom me-2">{stats.unresolved}</div>
            <span className="text-muted small">건</span>
          </div>
          <span className="small text-danger-custom mt-1 fw-bold">즉시 확인 및 조치 필요</span>
        </div>

        {/* 해결 완료 (Success) */}
        <div className="summary-card">
          <span className="summary-label text-success">
            <CheckCircle2 size={16} /> 해결 완료
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-success me-2">{stats.resolved}</div>
            <span className="text-muted small">건</span>
          </div>
          <span className="small text-muted mt-1">Status: RESOLVED</span>
        </div>

        {/* 서버 치명적 오류 (500 Error) */}
        <div className="summary-card">
          <span className="summary-label text-warning-custom">
            <ShieldAlert size={16} /> 치명적 오류 (500)
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-warning-custom me-2">{stats.critical}</div>
            <span className="text-muted small">건</span>
          </div>
          <span className="small text-muted mt-1">Internal Server Error</span>
        </div>
      </div>

      {/* 2. 검색 필터 카드 (Tudio Card 스타일 적용) */}
      <div className="card border-0 shadow-sm mb-4" style={{ borderRadius: 'var(--tudio-radius-md)', border: '1px solid var(--border-blue)' }}>
        <div className="card-body p-4" style={{ backgroundColor: 'var(--tudio-surface-soft)' }}>
          <div className="row g-3 align-items-end">
            <div className="col-md-4">
              <label className="form-label fw-bold small" style={{ color: 'var(--text-muted)' }}>발생 기간</label>
              <div className="input-group shadow-sm rounded-3 overflow-hidden">
                <input type="date" className="form-control border-blue" value={searchParams.startDate} onChange={(e) => setSearchParams({...searchParams, startDate: e.target.value})} />
                <span className="input-group-text bg-white border-blue text-muted small">to</span>
                <input type="date" className="form-control border-blue" value={searchParams.endDate} onChange={(e) => setSearchParams({...searchParams, endDate: e.target.value})} />
              </div>
            </div>
            <div className="col-md-6">
              <label className="form-label fw-bold small" style={{ color: 'var(--text-muted)' }}>검색어 (URL, 메시지)</label>
              <div className="input-group shadow-sm rounded-3 overflow-hidden">
                <span className="input-group-text bg-white border-blue"><Search size={16} className="text-muted"/></span>
                <input type="text" className="form-control border-blue border-start-0" placeholder="찾으시는 에러 키워드를 입력하세요" value={searchParams.keyword} onKeyDown={(e) => e.key === 'Enter' && handleSearch()} onChange={(e) => setSearchParams({...searchParams, keyword: e.target.value})} />
              </div>
            </div>
            <div className="col-md-2 d-flex gap-2">
              <button className="btn text-white flex-fill fw-bold shadow-sm" style={{ backgroundColor: 'var(--main-blue)', borderRadius: '10px' }} onClick={handleSearch}>검색</button>
              <button className="btn btn-outline-secondary shadow-sm" style={{ borderRadius: '10px' }} onClick={handleReset}><RotateCcw size={16} /></button>
            </div>
          </div>
        </div>
      </div>

      {/* 3. 목록 테이블 카드 (Tudio Card 스타일 적용) */}
      <div className="flex-grow-1 card shadow-sm overflow-hidden d-flex flex-column" style={{ border: '1px solid var(--border-blue)', borderRadius: 'var(--tudio-radius-md)', background: '#fff' }}>
        <div className="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
          <div className="ps-2">
            <h5 className="fw-bold mb-1 text-dark d-flex align-items-center gap-2">
              <AlertCircle size={18} className="text-danger"/> 오류 감지 목록
            </h5>
            <small className="text-muted">전체 내역 중 <span className="fw-bold" style={{ color: 'var(--main-blue)' }}>{pageInfo?.totalRecord || 0}</span>건이 조회되었습니다.</small>
          </div>
          <button className="btn btn-success btn-sm d-flex align-items-center gap-2 fw-bold px-3 py-2 rounded-3 shadow-sm" onClick={handleDownload}>
            <FileSpreadsheet size={16}/> 엑셀 다운로드
          </button>
        </div>

        <div className="table-responsive flex-grow-1">
          <table className="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th className="text-center py-3">No</th>
                <th className="text-center">Code</th>
                <th className="text-center">상태</th>
                <th>오류 메시지 요약</th>
                <th style={{ width: '25%' }}>요청 URL</th>
                <th>발생 일시</th>
                <th className="text-center">발생자</th>
              </tr>
            </thead>
            <tbody>
              {logs.map((log, index) => {
                const total = pageInfo?.totalRecord || 0;
                const current = pageInfo?.currentPage || 1;
                const size = pageInfo?.rowSize || 10;
                const rowNo = total > 0 ? total - ((current - 1) * size) - index : index + 1;
                const isResolved = log.errStatus === 'RESOLVED';

                return (
                  <tr key={log.errorLogId ?? index} className={isResolved ? 'opacity-75' : ''} style={{ cursor: 'pointer' }} onClick={() => setSelectedLog(log)}>
                    <td className="text-center text-muted small">{rowNo}</td>
                    <td className="text-center">{getCodeBadge(log.statusCode)}</td>
                    <td className="text-center">
                      <span className={`badge rounded-pill px-3 py-1 border ${isResolved ? 'bg-success bg-opacity-10 text-success border-success' : 'bg-danger bg-opacity-10 text-danger border-danger'}`}>
                        {isResolved ? '해결됨' : '미해결'}
                      </span>
                    </td>
                    <td className={`text-truncate ${isResolved ? 'text-muted' : 'text-dark fw-bold'}`} style={{ maxWidth: '300px' }}>{log.errorMessage}</td>
                    <td className="small text-truncate text-primary">{log.requestUri}</td>
                    <td className="text-muted small">{log.regDate ? new Date(log.regDate).toLocaleString() : '-'}</td>
                    <td className="text-center fw-bold text-secondary small">{log.memberNo || 'Guest'}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        
        {pageInfo && logs.length > 0 && (
          <div className="p-4 border-top" style={{ backgroundColor: 'var(--tudio-surface-soft)' }}>
            <Pagination pageInfo={pageInfo} onPageChange={handlePageChange} />
          </div>
        )}
      </div>

      {/* 4. 상세 모달 (Tudio 테마 시스템 완벽 반영) */}
      {selectedLog && (
        <div className="modal d-block" style={{ backgroundColor: 'rgba(15, 23, 42, 0.6)', backdropFilter: 'blur(6px)' }}>
          <div className="modal-dialog modal-dialog-centered modal-xl" style={{ maxWidth: '1200px' }}>
            <div className="modal-content shadow-lg border-0" style={{ borderRadius: 'var(--tudio-radius-lg)', overflow: 'hidden' }}>
              
              {/* 모달 헤더: 상태 강조 바(Sidebar Accent) 스타일 */}
              <div className={`modal-header border-bottom-0 pt-4 px-4 d-flex align-items-start border-start border-5 ${selectedLog.errStatus === 'RESOLVED' ? 'border-success' : 'border-danger'}`}>
                <div className="flex-grow-1">
                  <div className="d-flex align-items-center gap-2 mb-1">
                    <span className={`badge ${selectedLog.errStatus === 'RESOLVED' ? 'bg-success' : 'bg-danger'} rounded-pill px-3 shadow-sm`}>
                      {selectedLog.errStatus === 'RESOLVED' ? 'Resolved' : 'Unresolved'}
                    </span>
                    {getCodeBadge(selectedLog.statusCode)}
                  </div>
                  <h4 className="modal-title fw-bold text-dark mt-2">오류 상세 리포트</h4>
                </div>
                <button type="button" className="btn-close" onClick={closeModal}></button>
              </div>

              <div className="modal-body p-4 pt-2">
                {/* 메타 정보 섹션: Tudio Soft Surface 적용 */}
                <div className="row g-3 mb-4">
                  <div className="col-md-7">
                    <div className="h-100 p-3 bg-white border rounded-4 shadow-sm" style={{ borderColor: 'var(--border-blue) !important' }}>
                      <div className="text-muted small fw-bold mb-2 d-flex align-items-center gap-1">
                        <Link2 size={16} className="text-primary"/> 요청 API 주소
                      </div>
                      <div className="text-dark font-monospace small bg-light p-2 rounded border-start border-3 border-primary" style={{ wordBreak: 'break-all' }}>
                        {selectedLog.requestUri}
                      </div>
                    </div>
                  </div>
                  <div className="col-md-5">
                    <div className="h-100 p-3 bg-white border rounded-4 shadow-sm" style={{ borderColor: 'var(--border-blue) !important' }}>
                      <div className="text-muted small fw-bold mb-2 d-flex align-items-center gap-1">
                        <Clock size={16} className="text-primary"/> 발생 정보
                      </div>
                      <div className="text-dark small mb-1"><span className="fw-bold text-muted">일시:</span> {new Date(selectedLog.regDate).toLocaleString()}</div>
                      <div className="text-dark small"><span className="fw-bold text-muted">사용자:</span> ID {selectedLog.memberNo || 'Guest'}</div>
                    </div>
                  </div>
                </div>

                {/* 에러 메시지 강조 영역 */}
                <div className="mb-4">
                  <label className="form-label fw-bold text-secondary small d-flex align-items-center gap-2 px-1">
                    <AlertCircle size={16} className="text-danger"/> Error Message Summary
                  </label>
                  <div className="p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded-4 text-danger fw-bold shadow-inner" style={{ fontSize: '1.05rem' }}>
                    {selectedLog.errorMessage}
                  </div>
                </div>

                {/* 스택 트레이스: 다크 모드 & 커스텀 스크롤바 */}
                <div className="mb-0">
                  <div className="d-flex justify-content-between align-items-center mb-2 px-1">
                    <label className="form-label fw-bold text-secondary small mb-0 d-flex align-items-center gap-2">
                      <Info size={16} className="text-primary"/> Stack Trace <span className="badge bg-secondary opacity-50 fw-normal">Backend Log</span>
                    </label>
                    <button className={`btn btn-sm d-flex align-items-center gap-2 transition-all ${copied ? 'text-success fw-bold' : 'text-muted'}`} onClick={() => handleCopy(selectedLog.errorDetail)}>
                      {copied ? <ClipboardCheck size={14}/> : <Copy size={14}/>}
                      <span style={{ fontSize: '12px' }}>{copied ? '복사완료' : '전체 복사'}</span>
                    </button>
                  </div>
                  <div className="position-relative shadow-sm rounded-4 overflow-hidden">
                    <div className="p-4 bg-dark text-light-emphasis font-monospace custom-scrollbar" 
                         style={{ height: '260px', fontSize: '13px', overflowY: 'auto', whiteSpace: 'pre-wrap', lineHeight: '1.6', backgroundColor: '#1e293b' }}>
                      {selectedLog.errorDetail}
                    </div>
                  </div>
                </div>
              </div>

              {/* 푸터 버튼: Tudio 전용 .tudio-btn-block 적용 */}
              <div className="modal-footer bg-light-subtle border-top-0 p-4 pt-2 gap-3">
                <button type="button" className="tudio-btn-block secondary flex-fill" onClick={closeModal}>닫기</button>
                {selectedLog.errStatus !== 'RESOLVED' && (
                  <button type="button" className="tudio-btn-block primary flex-fill" onClick={() => handleResolve(selectedLog.errorLogId)}>
                    <CheckCircle2 size={18}/> 해결 완료 처리
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* 스타일 보조 */}
      <style>{`
        .table thead th { background-color: #f8fafc !important; font-weight: 700; color: #475569; border-bottom: 2px solid var(--border-blue); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .transition-all { transition: all 0.2s ease-in-out; }
      `}</style>
    </div>
  );
};

export default LogError;