import React, { useState } from 'react';
import { 
  Search, Plus, Settings, Trash2, X, 
  Building2, User, ChevronRight, CheckCircle2, Ban
} from 'lucide-react';

// 1. 샘플 데이터 (실제로는 API에서 가져올 데이터)
const MOCK_DATA = {
  all: [
    { type: 'company', id: 'user_abc', name: '에이비씨 테크놀로지', email: 'admin@abc-tech.com', status: '정상', date: '2025.10.12', 
      manager: '박담당', rep: '김대표', biznum: '123-45-67890', phone: '02-1234-5678', addr: '서울시 강남구' },
    { type: 'general', id: 'hong123', name: '홍길동', email: 'hong@test.com', status: '활성', date: '2024.01.01', 
      birth: '1990-05-05', gender: 'male', company: '(주)테스트컴퍼니', dept: '개발팀', position: '팀장' }
  ],
  general: [
    { type: 'general', id: 'hong123', name: '홍길동', email: 'hong@test.com', status: '활성', date: '2024.01.01', 
      birth: '1990-05-05', gender: 'male', company: '(주)테스트컴퍼니', dept: '개발팀', position: '팀장' }
  ],
  company: [
    { type: 'company', id: 'user_abc', name: '에이비씨 테크놀로지', email: 'admin@abc-tech.com', status: '정상', date: '2025.10.12', 
      manager: '박담당', rep: '김대표', biznum: '123-45-67890', phone: '02-1234-5678', addr: '서울시 강남구' }
  ],
  withdrawal: [
    { type: 'company', id: 'del_hyper', name: '(주)하이퍼데이터', email: 'admin@hyper.net', status: '탈퇴', date: '2024.12.30', reason: '서비스 불만족' }
  ]
};

const UserList = () => {
  const [activeTab, setActiveTab] = useState('all'); // 현재 탭
  const [selectedUser, setSelectedUser] = useState(null); // 모달에 띄울 선택된 유저 정보
  const [showCompanyModal, setShowCompanyModal] = useState(false);
  const [showGeneralModal, setShowGeneralModal] = useState(false);

  // 탭 변경 핸들러
  const handleTabChange = (tab) => setActiveTab(tab);

  // 모달 열기 핸들러
  const openModal = (user) => {
    setSelectedUser({ ...user }); // 데이터 복사해서 수정 가능하게 함
    if (user.type === 'company') {
      setShowCompanyModal(true);
    } else {
      setShowGeneralModal(true);
    }
  };

  // 모달 닫기
  const closeModal = () => {
    setShowCompanyModal(false);
    setShowGeneralModal(false);
    setSelectedUser(null);
  };

  // 인풋 변경 핸들러 (모달 내부 수정용)
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setSelectedUser(prev => ({ ...prev, [name]: value }));
  };

  // 삭제 핸들러
  const handleDelete = () => {
    if (window.confirm('정말로 삭제하시겠습니까?')) {
      alert('삭제되었습니다.');
      closeModal();
    }
  };

  // 저장 핸들러
  const handleSave = () => {
    alert('저장되었습니다.');
    closeModal();
  };

  return (
    <div className="flex-grow-1 p-5 d-flex flex-column">
      
      {/* 1. 상단 Breadcrumb & 타이틀 */}
      <div className="mb-4">
        <nav className="text-muted small mb-2 d-flex align-items-center gap-2">
          <span>Admin</span> <ChevronRight size={12} /> <span className="text-primary fw-bold">회원 관리</span>
        </nav>
        <div className="d-flex justify-content-between align-items-end">
          <h2 className="fw-bold text-dark m-0">회원 관리</h2>
          <button className="btn btn-primary d-flex align-items-center gap-2 fw-bold px-4" onClick={() => alert('신규 등록 모달 오픈')}>
            <Plus size={18} /> 신규 회원 등록
          </button>
        </div>
      </div>

      {/* 2. 탭 & 필터 영역 */}
      <div className="card shadow-sm border-0 flex-grow-1 d-flex flex-column">
        <div className="card-header bg-white border-bottom pt-3 pb-0 px-4">
          <ul className="nav nav-tabs border-0 gap-3" style={{ marginBottom: '-1px' }}>
            {['all', 'general', 'company', 'withdrawal'].map(tab => (
              <li className="nav-item" key={tab}>
                <button 
                  className={`nav-link px-0 pb-3 border-0 bg-transparent fw-bold ${activeTab === tab ? 'text-primary border-bottom border-primary border-2 active' : 'text-muted'}`}
                  style={{ borderRadius: 0 }}
                  onClick={() => handleTabChange(tab)}
                >
                  {tab === 'all' && '전체'}
                  {tab === 'general' && '일반 회원'}
                  {tab === 'company' && '기업 회원'}
                  {tab === 'withdrawal' && '탈퇴 회원'}
                </button>
              </li>
            ))}
          </ul>
        </div>

        {/* 3. 테이블 영역 */}
        <div className="card-body p-0">
          <div className="table-responsive">
            <table className="table table-hover align-middle mb-0" style={{ minWidth: '800px' }}>
              <thead className="bg-light text-muted small text-uppercase">
                <tr>
                  <th className="ps-4 py-3">유형</th>
                  <th className="py-3">이름/기업명</th>
                  <th className="py-3">계정(Email)</th>
                  {activeTab === 'withdrawal' && <th className="py-3">탈퇴 사유</th>}
                  <th className="py-3">상태</th>
                  <th className="py-3 text-center">{activeTab === 'withdrawal' ? '탈퇴일' : '등록일'}</th>
                  <th className="py-3 text-center pe-4">관리</th>
                </tr>
              </thead>
              <tbody>
                {MOCK_DATA[activeTab].map((user, idx) => (
                  <tr key={idx} style={{ cursor: 'pointer' }}>
                    <td className="ps-4">
                      <span className={`badge rounded-pill border px-2 py-1 ${user.type === 'company' ? 'bg-info bg-opacity-10 text-info border-info border-opacity-25' : 'bg-secondary bg-opacity-10 text-secondary border-secondary border-opacity-25'}`}>
                        {user.type === 'company' ? '기업' : '일반'}
                      </span>
                    </td>
                    <td className="fw-bold text-dark">{user.name}</td>
                    <td className="text-secondary">{user.email}</td>
                    {activeTab === 'withdrawal' && <td className="text-muted small">{user.reason}</td>}
                    <td>
                      {user.status === '탈퇴' ? (
                        <span className="badge bg-danger bg-opacity-10 text-danger px-2 py-1"><Ban size={12} className="me-1"/>탈퇴</span>
                      ) : (
                        <span className="badge bg-success bg-opacity-10 text-success px-2 py-1"><CheckCircle2 size={12} className="me-1"/>활성</span>
                      )}
                    </td>
                    <td className="text-center text-muted small number-font">{user.date}</td>
                    <td className="text-center pe-4">
                      <button 
                        className="btn btn-white border shadow-sm btn-sm p-1 rounded-circle text-secondary hover-bg-light"
                        onClick={() => openModal(user)}
                        title="상세 정보 수정"
                      >
                        <Settings size={16} />
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          {/* 데이터 없을 때 */}
          {MOCK_DATA[activeTab].length === 0 && (
             <div className="text-center py-5 text-muted">
               데이터가 없습니다.
             </div>
          )}
        </div>
      </div>

      {/* ========================================================================
        모달 영역 (Bootstrap Class 사용하되 React State로 표시 제어)
        ========================================================================
      */}

      {/* 1. 기업 회원 상세 모달 */}
      {showCompanyModal && selectedUser && (
        <div className="modal d-block" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered modal-lg">
            <div className="modal-content shadow-lg border-0">
              <div className="modal-header bg-dark text-white">
                <h5 className="modal-title fw-bold d-flex align-items-center gap-2">
                  <Building2 size={20} /> 고객사 상세 정보 수정
                </h5>
                <button type="button" className="btn-close btn-close-white" onClick={closeModal}></button>
              </div>
              <div className="modal-body p-4">
                <h6 className="text-primary fw-bold mb-3 pb-2 border-bottom">계정 정보 (메인 담당자)</h6>
                <div className="row g-3 mb-4">
                  <div className="col-md-4">
                    <label className="form-label small text-muted fw-bold">아이디</label>
                    <input type="text" className="form-control bg-light" value={selectedUser.id} readOnly />
                  </div>
                  <div className="col-md-4">
                    <label className="form-label small text-muted fw-bold">담당자 이름</label>
                    <input type="text" className="form-control" name="manager" value={selectedUser.manager || ''} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-4">
                    <label className="form-label small text-muted fw-bold">담당자 이메일</label>
                    <input type="email" className="form-control" name="email" value={selectedUser.email} onChange={handleInputChange} />
                  </div>
                </div>

                <h6 className="text-primary fw-bold mb-3 pb-2 border-bottom">기업 정보</h6>
                <div className="row g-3">
                  <div className="col-md-6">
                    <label className="form-label small text-muted fw-bold">기업명</label>
                    <input type="text" className="form-control fw-bold" name="name" value={selectedUser.name} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-6">
                    <label className="form-label small text-muted fw-bold">대표자명</label>
                    <input type="text" className="form-control" name="rep" value={selectedUser.rep || ''} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-6">
                    <label className="form-label small text-muted fw-bold">사업자 번호</label>
                    <input type="text" className="form-control" name="biznum" value={selectedUser.biznum || ''} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-6">
                     <label className="form-label small text-muted fw-bold">상태</label>
                     <select className="form-select" name="status" value={selectedUser.status} onChange={handleInputChange}>
                       <option value="정상">정상</option>
                       <option value="정지">정지</option>
                     </select>
                  </div>
                  <div className="col-12">
                     <label className="form-label small text-muted fw-bold">주소</label>
                     <input type="text" className="form-control" name="addr" value={selectedUser.addr || ''} onChange={handleInputChange} />
                  </div>
                </div>
              </div>
              <div className="modal-footer justify-content-between bg-light">
                <button className="btn btn-outline-danger d-flex align-items-center gap-1" onClick={handleDelete}><Trash2 size={16}/> 삭제</button>
                <div className="d-flex gap-2">
                  <button className="btn btn-secondary" onClick={closeModal}>취소</button>
                  <button className="btn btn-primary px-4" onClick={handleSave}>저장</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* 2. 일반 회원 상세 모달 */}
      {showGeneralModal && selectedUser && (
        <div className="modal d-block" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }}>
          <div className="modal-dialog modal-dialog-centered modal-lg">
            <div className="modal-content shadow-lg border-0">
              <div className="modal-header bg-dark text-white">
                <h5 className="modal-title fw-bold d-flex align-items-center gap-2">
                  <User size={20} /> 일반 회원 상세 정보 수정
                </h5>
                <button type="button" className="btn-close btn-close-white" onClick={closeModal}></button>
              </div>
              <div className="modal-body p-4">
                <h6 className="text-primary fw-bold mb-3 pb-2 border-bottom">기본 정보</h6>
                <div className="row g-3 mb-4">
                  <div className="col-md-6">
                    <label className="form-label small text-muted fw-bold">아이디</label>
                    <input type="text" className="form-control bg-light" value={selectedUser.id} readOnly />
                  </div>
                  <div className="col-md-6">
                    <label className="form-label small text-muted fw-bold">이메일</label>
                    <input type="email" className="form-control" name="email" value={selectedUser.email} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-4">
                    <label className="form-label small text-muted fw-bold">이름</label>
                    <input type="text" className="form-control" name="name" value={selectedUser.name} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-4">
                    <label className="form-label small text-muted fw-bold">생년월일</label>
                    <input type="date" className="form-control" name="birth" value={selectedUser.birth || ''} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-4">
                    <label className="form-label small text-muted fw-bold">성별</label>
                    <div className="d-flex gap-3 mt-2">
                      <div className="form-check">
                        <input className="form-check-input" type="radio" name="gender" value="male" checked={selectedUser.gender === 'male'} onChange={handleInputChange}/>
                        <label className="form-check-label">남성</label>
                      </div>
                      <div className="form-check">
                        <input className="form-check-input" type="radio" name="gender" value="female" checked={selectedUser.gender === 'female'} onChange={handleInputChange}/>
                        <label className="form-check-label">여성</label>
                      </div>
                    </div>
                  </div>
                </div>

                <h6 className="text-primary fw-bold mb-3 pb-2 border-bottom">소속 및 상태</h6>
                <div className="row g-3">
                  <div className="col-md-6">
                    <label className="form-label small text-muted fw-bold">소속 회사</label>
                    <input type="text" className="form-control" name="company" value={selectedUser.company || ''} onChange={handleInputChange} />
                  </div>
                  <div className="col-md-6">
                     <label className="form-label small text-muted fw-bold">부서 / 직급</label>
                     <div className="input-group">
                       <input type="text" className="form-control" name="dept" placeholder="부서" value={selectedUser.dept || ''} onChange={handleInputChange} />
                       <input type="text" className="form-control" name="position" placeholder="직급" value={selectedUser.position || ''} onChange={handleInputChange} />
                     </div>
                  </div>
                  <div className="col-md-6">
                     <label className="form-label small text-muted fw-bold">계정 상태</label>
                     <select className="form-select" name="status" value={selectedUser.status} onChange={handleInputChange}>
                       <option value="활성">활성</option>
                       <option value="비활성">비활성</option>
                     </select>
                  </div>
                </div>
              </div>
              <div className="modal-footer justify-content-between bg-light">
                <button className="btn btn-outline-danger d-flex align-items-center gap-1" onClick={handleDelete}><Trash2 size={16}/> 삭제</button>
                <div className="d-flex gap-2">
                  <button className="btn btn-secondary" onClick={closeModal}>취소</button>
                  <button className="btn btn-primary px-4" onClick={handleSave}>저장</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

export default UserList;