import { useEffect, useState } from 'react';
import { useSearchParams } from 'react-router-dom';
import axios from 'axios';
import { Users, LogIn, ShieldAlert, Activity } from 'lucide-react';
import { 
  ShieldCheck, Search, ChevronRight,
  Monitor, Smartphone, Globe, AlertCircle, CheckCircle2, FileSpreadsheet
} from 'lucide-react';

import Pagination from '../../../components/common/Pagination';

const LogLogin = () => {
  const [querySearchParams, setQuerySearchParams] = useSearchParams();
  const currentPage = parseInt(querySearchParams.get('page')) || 1;

  const [logs, setLogs] = useState([]);
  const [pageInfo, setPageInfo] = useState(null);

  const stats = {
    totalCount: pageInfo?.totalRecord || 0,
    successCount: 0, 
    failCount: 0,   
    activeUsers: 0   
  };

  // ë‚ ì§œ í•„í„°ìš© ìƒíƒœ
  const today = new Date().toISOString().split('T')[0];
  const [filters, setFilters] = useState({
    startDate: today,
    endDate: today,
    condition: 'all',
    keyword: '',
    status: 'all'
  });

  useEffect(() => {
    fetchLogs();
  }, [currentPage]);

  const fetchLogs = async () => {
    try {

      const params = {
        page: currentPage, 
        searchType: filters.condition, 
        searchWord: filters.keyword,  
        ...filters
      };

      const response = await axios.get('/api/log/login/list', {params});

      console.log("ì„œë²„ ì‘ë‹µ ë°ì´í„°:", response.data);

      const dataList = response.data.dataList || [];
      const pi = response.data.pageInfo; 

      setLogs(dataList);
      setPageInfo(pi);

    } catch (error) {
      console.error("ë¡œê·¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
  };

  const handlePageChange = (pageNum) => {
    setQuerySearchParams((prev) => {
      const next = new URLSearchParams(prev);
      next.set('page', pageNum);
      return next;
    });
  };

  const handleSearch = () => {
    setQuerySearchParams({ page: 1 });
    if(currentPage === 1) fetchLogs();
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') handleSearch();
  };

  const handleDownload = () => {
    const total = pageInfo?.totalRecord || 0;
    if(window.confirm(`í˜„ì¬ ì¡°íšŒëœ ${total}ê±´ì˜ ë¡œê·¸ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
  };

  // OS ì¶”ì¸¡ í•¨ìˆ˜
  const parseOs = (userAgent) => {
    if (!userAgent) return "Unknown OS";
    const ua = userAgent.toLowerCase();
    if (ua.includes("windows")) return "Windows";
    if (ua.includes("mac")) return "Mac OS";
    if (ua.includes("linux")) return "Linux";
    if (ua.includes("android")) return "Android";
    if (ua.includes("iphone") || ua.includes("ipad")) return "iOS";
    return "Other";
  };

  // OS ì•„ì´ì½˜ í—¬í¼
  const getOsIcon = (osName) => {
    const name = osName.toLowerCase();
    if (name.includes('windows') || name.includes('mac') || name.includes('linux')) return <Monitor size={14}/>;
    if (name.includes('android') || name.includes('ios')) return <Smartphone size={14}/>;
    return <Globe size={14}/>;
  };

  // ë‚ ì§œ í¬ë§·íŒ… 
  const formatDate = (dateString) => {
    if (!dateString) return "-";

    // 1. ë‚ ì§œ íŒŒì‹± 
    let date = new Date(dateString);
    if (isNaN(date.getTime())) {
      let isoString = dateString.replace(' ', 'T');
      date = new Date(isoString);
    }
    if (isNaN(date.getTime())) return dateString;

    // 2. ë‚ ì§œ/ì‹œê°„ ì§ì ‘ ì¶”ì¶œ
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    const second = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
  };

  return (
    <div className="flex-grow-1 p-5 d-flex flex-column h-100">
      
      {/* 1. Breadcrumb & Header */}
      <div className="mb-4">
        <nav className="text-muted small mb-2 d-flex align-items-center gap-2">
          <span>Admin</span> <ChevronRight size={12} /> 
          <span>ë¡œê·¸ ê´€ë¦¬</span> <ChevronRight size={12} />
          <span className="text-primary fw-bold">ë¡œê·¸ì¸ ë¡œê·¸</span>
        </nav>
        <h2 className="fw-bold text-dark m-0 d-flex align-items-center gap-2">
          <ShieldCheck size={24} className="text-primary" /> ë¡œê·¸ì¸ ì´ë ¥ ì¡°íšŒ
        </h2>
      </div>

      <div className="summary-container">
        {/* ì „ì²´ ë¡œê·¸ì¸ ì‹œë„ */}
        <div className="summary-card">
          <span className="summary-label text-primary-custom">
            <LogIn size={16} /> ì „ì²´ ì ‘ì† ì‹œë„
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value me-2">{stats.totalCount.toLocaleString()}</div>
            <span className="text-muted small">ê±´</span>
          </div>
          <span className="small text-muted mt-1">ì¡°íšŒ ë²”ìœ„ ë‚´ ì´ ë¡œê·¸ ìˆ˜</span>
        </div>

        {/* ë¡œê·¸ì¸ ì„±ê³µ */}
        <div className="summary-card">
          <span className="summary-label text-success">
            <CheckCircle2 size={16} /> ë¡œê·¸ì¸ ì„±ê³µ
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-success me-2">
              {/* APIì—ì„œ ê°’ì„ ì£¼ì§€ ì•Šì„ ê²½ìš° ì„ì‹œë¡œ SUCCESS ë¡œê·¸ë§Œ í•„í„°ë§í•œ ê°œìˆ˜ë¥¼ ì“¸ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ */}
              {logs.filter(l => l.loginStatus === 'SUCCESS').length} 
            </div>
            <span className="text-muted small">ê±´</span>
          </div>
          <span className="small text-muted mt-1">ì •ìƒì ìœ¼ë¡œ ì¸ì¦ëœ ì´ë ¥</span>
        </div>

        {/* ë¡œê·¸ì¸ ì‹¤íŒ¨ */}
        <div className="summary-card">
          <span className="summary-label text-danger-custom">
            <ShieldAlert size={16} /> ë¡œê·¸ì¸ ì‹¤íŒ¨
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-danger-custom me-2">
              {logs.filter(l => l.loginStatus === 'FAIL').length}
            </div>
            <span className="text-muted small">ê±´</span>
          </div>
          <span className="small text-danger-custom mt-1">ë³´ì•ˆ ì£¼ì˜ ë° íŒ¨ìŠ¤ì›Œë“œ ì˜¤ë¥˜</span>
        </div>

        {/* í™œì„± ì‚¬ìš©ì (IP ê¸°ì¤€) */}
        <div className="summary-card">
          <span className="summary-label text-warning-custom">
            <Activity size={16} /> ì ‘ì† IP ì¢…ë¥˜
          </span>
          <div className="d-flex align-items-baseline">
            <div className="summary-value text-warning-custom me-2">
              {new Set(logs.map(l => l.ipAddr)).size}
            </div>
            <span className="text-muted small">ê°œ</span>
          </div>
          <span className="small text-muted mt-1">ì¤‘ë³µì„ ì œì™¸í•œ ê³ ìœ  IP</span>
        </div>
      </div>

      {/* 2. ê²€ìƒ‰ í•„í„° ì˜ì—­ (ìƒë‹¨ ì¹´ë“œ) */}
      <div className="card border-0 shadow-sm rounded-3 mb-4 bg-white">
        <div className="card-body bg-light rounded-3 p-4">
            <div className="row g-3 align-items-end">
                <div className="col-md-4">
                    <label className="form-label fw-bold small text-muted">ì¡°íšŒ ê¸°ê°„</label>
                    <div className="input-group">
                        <input 
                            type="date" 
                            className="form-control" 
                            value={filters.startDate}
                            onChange={(e) => setFilters({...filters, startDate: e.target.value})}
                        />
                        <span className="input-group-text bg-white border-start-0 border-end-0">~</span>
                        <input 
                            type="date" 
                            className="form-control"
                            value={filters.endDate}
                            onChange={(e) => setFilters({...filters, endDate: e.target.value})}
                        />
                    </div>
                </div>
                
                <div className="col-md-5">
                    <label className="form-label fw-bold small text-muted">ê²€ìƒ‰ì–´</label>
                    <input 
                        type="text" 
                        className="form-control" 
                        placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        value={filters.keyword}
                        onChange={(e) => setFilters({...filters, keyword: e.target.value})}
                        onKeyDown={handleKeyDown}
                    />
                </div>

                <div className="col-md-2">
                    <label className="form-label fw-bold small text-muted">ë¡œê·¸ì¸ ìƒíƒœ</label>
                    <select className="form-select" value={filters.status} onChange={(e) => setFilters({...filters, status: e.target.value})}>
                        <option value="all">ì „ì²´</option>
                        <option value="SUCCESS">ì„±ê³µ</option> {/* ëŒ€ë¬¸ì ìˆ˜ì • */}
                        <option value="FAIL">ì‹¤íŒ¨</option>   {/* ëŒ€ë¬¸ì ìˆ˜ì • */}
                    </select>
                </div>

                <div className="col-md-1">
                    <button type="button" className="btn btn-primary w-100" onClick={handleSearch}>
                        <Search size={18} />
                    </button>
                </div>
            </div>
        </div>
      </div>

      {/* 3. ë¦¬ìŠ¤íŠ¸ ì˜ì—­ (í•˜ë‹¨ ì¹´ë“œ) */}
      <div className="flex-grow-1 card border-0 shadow-sm rounded-3 overflow-hidden d-flex flex-column bg-white">
        
        {/* ì¹´ë“œ í—¤ë” */}
        <div className="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
           <div>
             <h5 className="fw-bold mb-1">ğŸ“‹ ë¡œê·¸ì¸ ì´ë ¥ ëª©ë¡</h5>
             <small className="text-muted">
                ì´ <span className="text-primary fw-bold">{pageInfo?.totalRecord || 0}</span>ê±´ì˜ ë¡œê·¸ê°€ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤. 
             </small>
           </div>
           <button className="btn btn-success btn-sm d-flex align-items-center gap-2 fw-bold px-3" onClick={handleDownload}>
             <FileSpreadsheet size={16}/> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
           </button>
        </div>

        {/* í…Œì´ë¸” */}
        <div className="table-responsive flex-grow-1">
          <table className="table table-hover align-middle mb-0">
            <thead className="bg-light text-muted small text-uppercase">
              <tr>
                <th className="text-center py-3" style={{width:'60px'}}>No</th>
                <th className="ps-3 py-3">ì ‘ì† ì¼ì‹œ</th>
                <th className="py-3">ì‚¬ìš©ì (ID)</th>
                <th className="py-3">ì ‘ì† IP</th>
                <th className="py-3">OS / ë¸Œë¼ìš°ì €</th>
                <th className="text-center py-3">ìƒíƒœ</th>
                <th className="py-3">ë¹„ê³  (ì‹¤íŒ¨ ì‚¬ìœ )</th>
              </tr>
            </thead>
            <tbody>
              {logs && Array.isArray(logs) && logs.map((log, index) => {
                const osName = parseOs(log.userAgent);
                const formattedDate = formatDate(log.regDate);

                const total = pageInfo?.totalRecord || 0;
                const current = pageInfo?.currentPage || 1;
                const size = pageInfo?.rowSize || 10;

                const rowNo = total > 0 
                  ? total - ((current - 1) * size) - index 
                  : index + 1;
                
                return (
                <tr key={log.loginLogId ?? index}> 
                    <td className="text-center text-muted small">{rowNo}</td>
                  
                  {/* ë‚ ì§œì™€ ì‹œê°„ ë‘ ì¤„ë¡œ ë°°ì¹˜ */}
                  <td className="ps-3 text-muted small number-font">
                    <div>{formattedDate.split(' ')[0]}</div>
                    <div className="text-secondary" style={{fontSize: '0.85em'}}>
                        {formattedDate.split(' ')[1]}
                    </div>
                  </td>

                  <td className="fw-bold text-dark">{log.loginId}</td>
                  <td className="text-secondary small number-font">{log.ipAddr}</td>
                  <td>
                    <div className="d-flex align-items-center gap-2 small text-muted">
                       {getOsIcon(osName)}
                       {osName} / {log.browser}
                    </div>
                  </td>
                  <td className="text-center">
                    {log.loginStatus === 'SUCCESS' ? (
                      <span className="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3">
                        <CheckCircle2 size={12} className="me-1"/> ì„±ê³µ
                      </span>
                    ) : (
                      <span className="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill px-3">
                        <AlertCircle size={12} className="me-1"/> ì‹¤íŒ¨
                      </span>
                    )}
                  </td>
                  <td className="text-muted small">
                    {log.loginStatus !== 'SUCCESS' ? <span className="text-danger">{log.failReason}</span> : '-'}
                  </td>
                </tr>
              )})}
              
              {logs.length === 0 && (
                <tr>
                    <td colSpan="7" className="text-center py-5 text-muted">
                        <div className="d-flex flex-column align-items-center">
                            <AlertCircle size={40} className="text-muted mb-2 opacity-50"/>
                            <span>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                        </div>
                    </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        {pageInfo && logs.length > 0 && (
            <div className="p-4 border-top">
                <Pagination pageInfo={pageInfo} onPageChange={handlePageChange} />
            </div>
        )}
      </div>
    </div>
  );
};

export default LogLogin;