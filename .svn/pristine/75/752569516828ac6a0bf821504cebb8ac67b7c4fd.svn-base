import React, { useState } from 'react';
import { 
  ClipboardList, Plus, Trash2, Save, ChevronRight, 
  GripVertical, CheckCircle2, List, Move
} from 'lucide-react';

const SurveyForm = () => {
  // 설문 기본 정보
  const [info, setInfo] = useState({ 
    title: '', 
    description: '', 
    startDate: '', 
    endDate: '' 
  });

  // 질문 목록 (기본값: 1개 질문)
  const [questions, setQuestions] = useState([
    { 
      id: Date.now(), 
      type: 'radio', // radio(단일), checkbox(중복), scale(척도)
      content: '', 
      options: [{ id: 1, text: '' }, { id: 2, text: '' }] 
    }
  ]);

  // === 핸들러 함수들 ===

  // 1. 질문 추가
  const addQuestion = () => {
    setQuestions([
      ...questions, 
      { 
        id: Date.now(), 
        type: 'radio', 
        content: '', 
        options: [{ id: 1, text: '' }] 
      }
    ]);
  };

  // 2. 질문 삭제
  const removeQuestion = (qId) => {
    if (questions.length === 1) return alert("최소 1개의 질문은 있어야 합니다.");
    setQuestions(questions.filter(q => q.id !== qId));
  };

  // 3. 질문 내용 변경
  const updateQuestion = (qId, field, value) => {
    setQuestions(questions.map(q => q.id === qId ? { ...q, [field]: value } : q));
  };

  // 4. 옵션(보기) 추가
  const addOption = (qId) => {
    setQuestions(questions.map(q => 
      q.id === qId ? { ...q, options: [...q.options, { id: Date.now(), text: '' }] } : q
    ));
  };

  // 5. 옵션(보기) 삭제
  const removeOption = (qId, optId) => {
    setQuestions(questions.map(q => 
      q.id === qId ? { ...q, options: q.options.filter(o => o.id !== optId) } : q
    ));
  };

  // 6. 옵션 텍스트 변경
  const updateOption = (qId, optId, text) => {
    setQuestions(questions.map(q => 
      q.id === qId ? { 
        ...q, 
        options: q.options.map(o => o.id === optId ? { ...o, text } : o) 
      } : q
    ));
  };

  // 저장
  const handleSave = () => {
    if (!info.title) return alert("설문 제목을 입력해주세요.");
    console.log("저장될 데이터:", { info, questions });
    alert("설문이 저장되었습니다.");
    // window.location.href = '/admin/survey';
  };

  return (
    <div className="flex-grow-1 p-5 d-flex flex-column h-100">
      
      {/* 헤더 */}
      <div className="mb-4">
        <nav className="text-muted small mb-2 d-flex align-items-center gap-2">
          <span>Admin</span> <ChevronRight size={12} /> 
          <span>설문 관리</span> <ChevronRight size={12} />
          <span className="text-primary fw-bold">설문 작성</span>
        </nav>
        <h2 className="fw-bold text-dark m-0 d-flex align-items-center gap-2">
          <ClipboardList size={24} className="text-primary" /> 설문 생성 / 수정
        </h2>
      </div>

      <div className="flex-grow-1 overflow-auto pb-5">
        
        {/* 1. 설문 기본 설정 카드 */}
        <div className="card border-0 shadow-sm rounded-3 mb-4 bg-white">
          <div className="card-header bg-light py-3 px-4 fw-bold text-dark">
            📋 기본 정보 설정
          </div>
          <div className="card-body p-4">
            <div className="mb-3">
              <label className="form-label fw-bold small text-muted">설문 제목</label>
              <input 
                type="text" 
                className="form-control form-control-lg fw-bold" 
                placeholder="설문 제목을 입력하세요"
                value={info.title}
                onChange={(e) => setInfo({...info, title: e.target.value})}
              />
            </div>
            <div className="mb-3">
              <label className="form-label fw-bold small text-muted">설문 설명</label>
              <textarea 
                className="form-control" 
                rows="3" 
                placeholder="참여자에게 보여질 설명 문구를 입력하세요"
                value={info.description}
                onChange={(e) => setInfo({...info, description: e.target.value})}
              ></textarea>
            </div>
            <div className="row">
              <div className="col-md-6">
                <label className="form-label fw-bold small text-muted">시작일</label>
                <input type="date" className="form-control" value={info.startDate} onChange={e=>setInfo({...info, startDate: e.target.value})}/>
              </div>
              <div className="col-md-6">
                <label className="form-label fw-bold small text-muted">종료일</label>
                <input type="date" className="form-control" value={info.endDate} onChange={e=>setInfo({...info, endDate: e.target.value})}/>
              </div>
            </div>
          </div>
        </div>

        {/* 2. 질문 목록 영역 */}
        {questions.map((q, idx) => (
          <div key={q.id} className="card border-0 shadow-sm rounded-3 mb-4 bg-white position-relative">
            {/* 좌측 드래그 핸들 (디자인용) */}
            <div className="position-absolute top-0 bottom-0 start-0 bg-light d-flex align-items-center justify-content-center rounded-start" style={{width: '30px', cursor:'move'}}>
                <GripVertical size={16} className="text-muted opacity-50"/>
            </div>

            <div className="card-body p-4 ps-5">
              <div className="d-flex justify-content-between align-items-start mb-3">
                <div className="d-flex align-items-center gap-2 flex-grow-1 me-3">
                  <span className="badge bg-primary rounded-pill">Q{idx + 1}</span>
                  <input 
                    type="text" 
                    className="form-control fw-bold border-0 bg-light" 
                    placeholder="질문 내용을 입력하세요"
                    value={q.content}
                    onChange={(e) => updateQuestion(q.id, 'content', e.target.value)}
                  />
                </div>
                <div className="d-flex gap-2">
                  <select 
                    className="form-select form-select-sm" 
                    style={{width:'140px'}}
                    value={q.type}
                    onChange={(e) => updateQuestion(q.id, 'type', e.target.value)}
                  >
                    <option value="radio">단일 선택 (Radio)</option>
                    <option value="checkbox">중복 선택 (Check)</option>
                    <option value="scale">척도형 (1~5점)</option>
                  </select>
                  <button className="btn btn-outline-danger btn-sm" onClick={() => removeQuestion(q.id)}>
                    <Trash2 size={16}/>
                  </button>
                </div>
              </div>

              {/* 옵션(보기) 영역 */}
              <div className="ps-4 border-start border-3 border-light">
                
                {q.type === 'scale' ? (
                   <div className="alert alert-light border d-flex justify-content-center text-muted small py-4">
                      1점 (매우 불만족) ~ 5점 (매우 만족) 선택형으로 표시됩니다.
                   </div>
                ) : (
                  <>
                    {q.options.map((opt) => (
                      <div key={opt.id} className="d-flex align-items-center gap-2 mb-2">
                        {q.type === 'radio' ? <div className="rounded-circle border" style={{width:16, height:16}}></div> : <div className="rounded-1 border" style={{width:16, height:16}}></div>}
                        <input 
                          type="text" 
                          className="form-control form-control-sm border-bottom border-0 rounded-0" 
                          placeholder={`보기 입력`}
                          value={opt.text}
                          onChange={(e) => updateOption(q.id, opt.id, e.target.value)}
                        />
                        <button className="btn btn-link text-muted p-0" onClick={() => removeOption(q.id, opt.id)}>
                          <Trash2 size={14}/>
                        </button>
                      </div>
                    ))}
                    <button className="btn btn-light btn-sm text-primary fw-bold mt-2" onClick={() => addOption(q.id)}>
                      <Plus size={14} className="me-1"/> 옵션 추가
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        ))}

        {/* 하단 버튼 영역 */}
        <div className="d-flex justify-content-center mb-5">
           <button className="btn btn-outline-primary btn-lg fw-bold px-5 d-flex align-items-center gap-2" onClick={addQuestion}>
             <Plus size={20}/> 질문 추가하기
           </button>
        </div>

      </div>

      {/* 저장 플로팅 바 (하단 고정) */}
      <div className="fixed-bottom bg-white border-top shadow-lg p-3" style={{marginLeft: 'var(--sidebar-width)'}}> {/* 사이드바 너비만큼 밀기 */}
         <div className="container-fluid d-flex justify-content-end gap-2">
            <button className="btn btn-secondary px-4">취소</button>
            <button className="btn btn-primary px-5 fw-bold d-flex align-items-center gap-2" onClick={handleSave}>
               <Save size={18}/> 설문 저장
            </button>
         </div>
      </div>

    </div>
  );
};

export default SurveyForm;