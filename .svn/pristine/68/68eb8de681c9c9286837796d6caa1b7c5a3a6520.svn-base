import React, { useEffect, useState, useCallback } from 'react';
import axios from 'axios';
import {
  Activity,
  AlertCircle,
  CheckCircle2,
  ChevronRight,
  Clock,
  FileSpreadsheet,
  Info,
  RotateCw,
  Search,
  Zap
} from 'lucide-react';
import { useSearchParams } from 'react-router-dom';
import Pagination from '../../../components/common/Pagination';

// 공통 CSS 임포트 (admin-stat-card 및 레이아웃 스타일)
import '../../../assets/css/admin/pages/AdminCommon.css';

const LogBatch = () => {
  const [querySearchParams, setQuerySearchParams] = useSearchParams();
  const currentPage = parseInt(querySearchParams.get('page')) || 1;
  const [logs, setLogs] = useState([]);
  const [pageInfo, setPageInfo] = useState(null);

  // 필터 상태 (오늘 날짜 기준)
  const today = new Date().toISOString().split('T')[0];
  const [filters, setFilters] = useState({ 
    startDate: today, 
    endDate: today, 
    keyword: '', 
    status: 'all' 
  });

  // 상단 카드 통계 계산
  const stats = {
    total: pageInfo?.totalRecord || 0,
    success: logs.filter(l => l.batchStatus === 'SUCCESS').length,
    fail: logs.filter(l => l.batchStatus === 'FAIL').length,
    avgDuration: logs.length > 0 
      ? Math.round(logs.reduce((acc, curr) => acc + (curr.duration || 0), 0) / logs.length) 
      : 0
  };

  const fetchLogs = useCallback(async () => {
    try {
      const params = { 
        page: currentPage, 
        searchWord: filters.keyword, 
        startDate: filters.startDate,
        endDate: filters.endDate,
        status: filters.status === 'all' ? '' : filters.status
      };
      const response = await axios.get('/api/log/batch/list', { params });
      
      setLogs(response.data.dataList || []);
      setPageInfo(response.data); 
    } catch (error) {
      console.error("배치 로그 조회 실패:", error);
    }
  }, [currentPage, filters]);

  useEffect(() => { 
    fetchLogs(); 
  }, [currentPage]);

  const handleSearch = () => {
    setQuerySearchParams({ page: 1 });
    fetchLogs();
  };

  const formatDuration = (seconds) => {
    if (!seconds || seconds < 0) return "0초";
    if (seconds < 60) return `${seconds}초`;
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}분 ${sec}초`;
  };

  return (
    <div className="flex-grow-1 p-5 d-flex flex-column admin-content-wrapper meeting-room-scope">
      
      {/* 1. 상단 타이틀 영역 */}
      <div className="admin-title-row mb-4 d-flex justify-content-between align-items-end">
        <div>
          <nav className="text-muted small mb-2 d-flex align-items-center gap-2">
            <span>Admin</span> <ChevronRight size={12} /> <span>로그 관리</span> <ChevronRight size={12} /> <span className="text-primary fw-bold">배치 로그</span>
          </nav>
          <h2 className="admin-page-title m-0">
            <RotateCw size={24} className="text-primary me-2" />배치 로그 조회
          </h2>
        </div>
        <button className="tudio-btn border bg-white shadow-sm d-flex align-items-center gap-2" onClick={() => window.confirm('다운로드 하시겠습니까?')}>
          <FileSpreadsheet size={16} className="text-success" /> 엑셀 다운로드
        </button>
      </div>

      {/* 2. 대시보드 통계 카드 - UserList 스타일 이식 */}
      <div className="row g-4 mb-5">
        <div className="col-3">
          <div className="admin-stat-card h-100">
            <div className="stat-header">
              <Activity size={18} className="text-primary-custom me-2" /> 전체 실행 횟수
            </div>
            <div className="stat-value-row">
              <span className="stat-value-big text-primary-custom">{stats.total.toLocaleString()}</span>
              <span className="text-muted small">건</span>
            </div>
            <p className="stat-desc">스케줄러에 의한 총 실행수</p>
          </div>
        </div>
        
        <div className="col-3">
          <div className="admin-stat-card h-100">
            <div className="stat-header">
              <CheckCircle2 size={18} className="text-success me-2" /> 실행 성공
            </div>
            <div className="stat-value-row">
              <span className="stat-value-big text-success">{stats.success.toLocaleString()}</span>
              <span className="text-muted small">건</span>
            </div>
            <p className="stat-desc">정상 종료된 배치 작업</p>
          </div>
        </div>

        <div className="col-3">
          <div className="admin-stat-card h-100">
            <div className="stat-header">
              <AlertCircle size={18} className="text-danger-custom me-2" /> 실행 실패
            </div>
            <div className="stat-value-row">
              <span className="stat-value-big text-danger-custom">{stats.fail.toLocaleString()}</span>
              <span className="text-muted small">건</span>
            </div>
            <p className="stat-desc">에러 로그 확인 필요</p>
          </div>
        </div>

        <div className="col-3">
          <div className="admin-stat-card h-100">
            <div className="stat-header">
              <Zap size={18} className="text-warning me-2" /> 평균 소요 시간
            </div>
            <div className="stat-value-row">
              <span className="stat-value-big text-warning">{formatDuration(stats.avgDuration)}</span>
            </div>
            <p className="stat-desc">작업당 평균 퍼포먼스</p>
          </div>
        </div>
      </div>

      {/* 3. 검색 필터 영역 */}
      <div className="admin-common-box shadow-sm mb-4 p-4" style={{ backgroundColor: '#f8fafc' }}>
        <div className="row g-3 align-items-end">
          <div className="col-md-3">
            <label className="form-label fw-bold small text-muted">조회 기간</label>
            <div className="input-group input-group-sm">
              <input type="date" className="form-control border-light" value={filters.startDate} onChange={(e) => setFilters({...filters, startDate: e.target.value})} />
              <span className="input-group-text bg-white border-light text-muted">~</span>
              <input type="date" className="form-control border-light" value={filters.endDate} onChange={(e) => setFilters({...filters, endDate: e.target.value})} />
            </div>
          </div>
          <div className="col-md-2">
            <label className="form-label fw-bold small text-muted">상태</label>
            <select className="form-select form-select-sm border-light" value={filters.status} onChange={(e) => setFilters({...filters, status: e.target.value})}>
              <option value="all">전체 상태</option>
              <option value="SUCCESS">성공</option>
              <option value="FAIL">실패</option>
            </select>
          </div>
          <div className="col-md-5">
            <label className="form-label fw-bold small text-muted">검색어 (작업명/메시지)</label>
            <div className="input-group input-group-sm">
              <span className="input-group-text bg-white border-light"><Search size={16} className="text-muted"/></span>
              <input type="text" className="form-control border-light" placeholder="검색어 입력..." value={filters.keyword} onChange={(e) => setFilters({...filters, keyword: e.target.value})} onKeyDown={(e) => e.key === 'Enter' && handleSearch()} />
            </div>
          </div>
          <div className="col-md-2">
            <button className="tudio-btn tudio-btn-primary w-100 fw-bold shadow-sm" onClick={handleSearch}>
              검색
            </button>
          </div>
        </div>
      </div>

      {/* 4. 목록 테이블 영역 */}
      <div className="admin-common-box flex-grow-1 d-flex flex-column shadow-sm overflow-hidden">
        <div className="p-4 bg-white border-bottom d-flex justify-content-between align-items-center">
          <h4 className="m-0 fw-bold" style={{fontSize: '1.15rem'}}>
            배치 실행 목록 <span className="text-primary ms-2 small">{pageInfo?.totalRecord || 0}건</span>
          </h4>
        </div>

        <div className="table-responsive flex-grow-1">
          <table className="table table-hover align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="text-center py-3" style={{width:'70px'}}>No</th>
                <th style={{width: '250px'}}>작업명</th>
                <th className="text-center" style={{width:'110px'}}>상태</th>
                <th>실행 정보</th>
                <th style={{width:'150px'}}>소요 시간</th>
                <th style={{width:'220px'}}>시작 / 종료 일시</th>
              </tr>
            </thead>
            <tbody>
              {logs.map((log, index) => {
                const total = pageInfo?.totalRecord || 0;
                const current = pageInfo?.currentPage || 1;
                const size = pageInfo?.rowSize || 10;
                const rowNo = total - ((current - 1) * size) - index;

                return (
                  <tr key={log.batchLogId || index}>
                    <td className="text-center small text-muted">{rowNo || '-'}</td>
                    <td>
                      <div className="fw-bold text-dark">{log.jobName}</div>
                      <div className="text-muted extra-small d-flex align-items-center gap-1">
                        <Info size={10} className="text-primary"/> {log.batchParams || '파라미터 없음'}
                      </div>
                    </td>
                    <td className="text-center">
                      <span className={`badge rounded-pill px-3 py-1 border ${log.batchStatus === 'SUCCESS' ? 'bg-success bg-opacity-10 text-success border-success' : 'bg-danger bg-opacity-10 text-danger border-danger'}`}>
                        {log.batchStatus === 'SUCCESS' ? '성공' : '실패'}
                      </span>
                    </td>
                    <td className="small">
                      <div className="text-truncate" style={{maxWidth:'300px'}} title={log.resultMsg}>{log.resultMsg}</div>
                      {log.errorLogId && (
                        <button 
                          className="btn btn-link p-0 extra-small text-danger fw-bold" 
                          onClick={() => alert(`에러 로그 #${log.errorLogId} 상세 보기로 이동합니다.`)}
                        >
                          에러 로그 확인 #{log.errorLogId}
                        </button>
                      )}
                    </td>
                    <td className="small text-muted">
                      <div className="d-flex align-items-center gap-1">
                        <Clock size={12} className="text-warning"/> {formatDuration(log.duration)}
                      </div>
                    </td>
                    <td className="extra-small text-muted">
                      <div className="d-flex flex-column gap-1">
                        <span><span className="badge bg-light text-dark me-1">Start</span> {log.startDate ? new Date(log.startDate).toLocaleString() : '-'}</span>
                        <span><span className="badge bg-light text-dark me-1">End</span> {log.regDate ? new Date(log.regDate).toLocaleString() : '-'}</span>
                      </div>
                    </td>
                  </tr>
                );
              })}
              {logs.length === 0 && (
                <tr><td colSpan="6" className="text-center py-5 text-muted">조회된 배치 로그가 없습니다.</td></tr>
              )}
            </tbody>
          </table>
        </div>

        {pageInfo && pageInfo.totalRecord > 0 && (
          <div className="p-4 border-top bg-white">
            <Pagination 
              pageInfo={pageInfo} 
              onPageChange={(n) => setQuerySearchParams({page: n})} 
            />
          </div>
        )}
      </div>
    </div>
  );
};

export default LogBatch;